let assert = require('assert');
let h = require('./helpers');
let exec = require('child_process').execSync;

const PROJECT_DIR = process.env.PROJECT_DIR;
const JAKE_CMD = `${PROJECT_DIR}/bin/cli.js`;

suite('taskBase', function () {

  this.timeout(7000);

  test('default task', function () {
    let out;
    out = exec(`${JAKE_CMD} -q`).toString().trim();
    assert.equal(out, 'default task');
    out = exec(`${JAKE_CMD} -q default`).toString().trim();
    assert.equal(out, 'default task');
  });

  test('task with no action', function () {
    let out = exec(`${JAKE_CMD} -q noAction`).toString().trim();
    assert.equal(out, 'default task');
  });

  test('a task with no action and no prereqs', function () {
    exec(`${JAKE_CMD} noActionNoPrereqs`);
  });

  test('a task that exists at the top-level, and not in the specified namespace, should error', function () {
    let res = require('child_process').spawnSync(`${JAKE_CMD}`,
      ['asdfasdfasdf:zerbofrangazoomy']);
    let err = res.stderr.toString();
    assert.ok(err.indexOf('Unknown task' > -1));
  });

  test('passing args to a task', function () {
    let out = exec(`${JAKE_CMD} -q argsEnvVars[foo,bar]`).toString().trim();
    let parsed = h.parse(out);
    let args = parsed.args;
    assert.equal(args[0], 'foo');
    assert.equal(args[1], 'bar');
  });

  test('a task with environment vars', function () {
    let out = exec(`${JAKE_CMD} -q argsEnvVars foo=bar baz=qux`).toString().trim();
    let parsed = h.parse(out);
    let env = parsed.env;
    assert.equal(env.foo, 'bar');
    assert.equal(env.baz, 'qux');
  });

  test('passing args and using environment vars', function () {
    let out = exec(`${JAKE_CMD} -q argsEnvVars[foo,bar] foo=bar baz=qux`).toString().trim();
    let parsed = h.parse(out);
    let args = parsed.args;
    let env = parsed.env;
    assert.equal(args[0], 'foo');
    assert.equal(args[1], 'bar');
    assert.equal(env.foo, 'bar');
    assert.equal(env.baz, 'qux');
  });

  test('a simple prereq', function () {
    let out = exec(`${JAKE_CMD} -q foo:baz`).toString().trim();
    assert.equal(out, 'foo:bar task\nfoo:baz task');
  });

  test('a duplicate prereq only runs once', function () {
    let out = exec(`${JAKE_CMD} -q foo:asdf`).toString().trim();
    assert.equal(out, 'foo:bar task\nfoo:baz task\nfoo:asdf task');
  });

  test('a prereq with command-line args', function () {
    let out = exec(`${JAKE_CMD} -q foo:qux`).toString().trim();
    assert.equal(out, 'foo:bar[asdf,qwer] task\nfoo:qux task');
  });

  test('a prereq with args via invoke', function () {
    let out = exec(`${JAKE_CMD} -q foo:frang[zxcv,uiop]`).toString().trim();
    assert.equal(out, 'foo:bar[zxcv,uiop] task\nfoo:frang task');
  });

  test('a prereq with args via execute', function () {
    let out = exec(`${JAKE_CMD} -q foo:zerb[zxcv,uiop]`).toString().trim();
    assert.equal(out, 'foo:bar[zxcv,uiop] task\nfoo:zerb task');
  });

  test('repeating the task via execute', function () {
    let out = exec(`${JAKE_CMD} -q foo:voom`).toString().trim();
 